<!doctype HTML>
<html>
    
<head>
  <meta charset="utf-8">
  <title>License to Spell</title>
  
<!-- ///////////////////////////////// -->
<!-- //////////    CSS     /////////// -->
<!-- ///////////////////////////////// -->
  
  <style>
  
  
    body {
        margin:0;
        padding:0
    }
    
    * {
        white-space: nowrap;
    }
  
    :not(.frame) { overflow: hidden; }

    div.explode-wrapper {
        display: flex;
        justify-content: center;        
    }
  
    .container {
        -ms-overflow-style: none;
        scrollbar-width: none;
        width: 100%;
        height: 100%;
    }
    
    #name-of-game {
        margin: auto;
        grid-column: 1/3;
        grid-row: 1/2;
    }
    
    #controls {
        position: absolute;
        width: 100%;
        height: 50vh;
        display: grid;
        font-size: 42px;
        grid-template-columns: repeat(10, 1fr);
        grid-template-rows: repeat(5, 1fr);
    }
    
    #notification-area {
        grid-column: 5/7;
        grid-row: 1/3;
        font-family:"penitentiary gothic";
        text-align: center;
    }
    
    #lexicon-chooser {
        grid-column: 3/9;
        grid-row: 2/4;
        height: 140px;
        justify-self: center;
        border-radius: 5px;
        border: white solid 2px;
        padding: 4px;
        font-family: 'highway gothic';
        font-size: 32px;
        color: white;
        background-color: rgb(0, 153, 0);
    }
    
    #copyright {
        margin-top: 0px;
        font-size: 20px;
    }
    
    #how-to {
        margin-left: 15px;
        grid-column: 1/4;
        grid-row: 3/6;
        font-size: 14px;
    }
    
    #start-button {
        grid-column: 5/7;
        grid-row: 5/6;
        margin-bottom: 25px;
        justify-self: center;
        align-self: center;
        text-align: center;
        padding: 12px 60px 12px 60px;
        font-size: 36px;
    }
    
    #score {
      font-family: 'highway gothic';
      width: max(16%, 160px);
      border-radius: 4px;
      border: black solid 2px;
      text-align: center;
      margin-right: 30px;
      justify-self: center;
      align-self: center;
      grid-column: 10/11;
      grid-row: 1/3;
      background-color: rgb(248, 186, 5)
    }
    
    #accuracy {
      font-family: 'highway gothic';
      width: max(16%, 160px);
      border-radius: 4px;
      border: black solid 2px;
      text-align: center;
      margin-right: 30px;
      justify-self: center;
      align-self: center;
      grid-column: 10/11;
      grid-row: 4/6;
      background-color: rgb(255, 102, 0);
    }
    
    #timer {
        font-family: 'highway gothic';
        width: 90px;
        height: 60px;
        grid-column: 1/2;
        grid-row: 1/3;
        margin-left: 20px;
        justify-self: center;
        align-self: center;
        text-align: center;
        border-radius: 5px;
        border: white solid 2px;
        font-family: 'highway gothic';
        font-size: 34px;
        color: white;
        background-color: rgb(0, 153, 0);
    }    
    
    #timer > * {
        margin: auto;
    }
    
    #entry {
      border-radius: 5px;
      justify-self: center;
      align-self: center;
      grid-column: 5/7;
      grid-row: 5/6;
      font-size: 36px;
    }
    

    .backdrop {
      position: absolute;
      z-index: -1;
    }

    .dash {
        fill: rgb(240, 241, 234);
        transform-origin: center center;
        animation-name: approach-center;
        animation-timing-function: cubic-bezier(1,.2,.95,.6);
        animation-duration: 3s;
        animation-fill-mode: forwards;
        animation-iteration-count: infinite;
    }
    .delayed {
        transform: translateY(320px); /* offscreen */
        animation-delay: 1.5s;
    }
     
    .frame {
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        position: absolute;
        width: 300px;
        height: 150px;
        animation-timing-function: cubic-bezier(1,.2,.95,.6);
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
        animation-duration: 15s;
    }
    
    .plate {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .lettering {
        position: absolute;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        line-height: 150px;
        font-size: 100px;
    }
    
    .scoreAlert {
        color: orange;
        font-family: sans-serif;
        font-size: 60px;
        position: absolute;
        transform: translate(100%, -50%);
        animation-name: fade-up;
        animation-duration: 3s;
        animation-iteration-count: 1;
        animation-timing-function: ease-out;
    }
    
    .roadside {
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        position: absolute;
        width: 120px;
        height: 120px;
        transform: translate(-50%, -50%);
        animation-name: approach-side;
        animation-timing-function: cubic-bezier(1,.2,.95,.6);
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
        animation-duration: 60s;        
    }
    
    .animate-left { animation-name: approach-left; }
    .animate-right { animation-name: approach-right; }
    .paused { animation-play-state: paused; }

    @keyframes approach-side {
      from { transform: translate(54vw, 51vh) translate(-150px, -75px) scale(0.04); }
      to { transform: translate(174vw, 81vh) translate(-150px, -75px) scale(1); }
    }
    
    @keyframes approach-center {
      from { transform: scale(0.04); }
      to { transform: translateY(23px) scale(1); }
    }

    @keyframes approach-left {
      from { transform: translate(49vw, 52vh) translate(-150px, -75px) scale(0.10); }
      75% {opacity: 100;}
      to { transform: translate(25vw, 100vh) translate(-150px, -75px) scale(1.25);
          opacity: 0; }
    }
    

    @keyframes approach-right {
      from { transform: translate(51vw, 52vh) translate(-150px, -75px) scale(0.10); }
      75% {opacity: 100;}
      to { transform: translate(75vw, 100vh) translate(-150px, -75px) scale(1.25);
          opacity: 0; }
    }
    

    @keyframes fade-up {
        from { top: -50%; opacity: 1; }
        to { top: -200%; opacity: 0; }
    }
    
    @font-face{
        font-family:"penitentiary gothic";
        src: url("fonts/E-phemera - Penitentiary Gothic Fill.ttf");
        format("truetype");
    }
    
    @font-face {
       font-family: 'highway gothic';
       src: url("fonts/TRAFFIC2.TTF");
    }

    @font-face {
       font-family: 'LicensePlate';
       src: url("fonts/LicensePlate.ttf");
    }
    
<!-- ///////////////////////////////// -->
<!-- //////////     JS      ////////// -->
<!-- ///////////////////////////////// -->
      
  </style>

    <script type="text/javascript" src="/lib/trie.js"></script>
    <script type="text/javascript" src="/lib/imgexplode.js"></script>
    
    <script>

        const topPlays = new Map();
        const lexicon = new Trie();

        let button,
            entry,
            plates,
            gameActive = false,
            score = 0,
            accuracy = [0, 0];
            
        fetch("plates.json")
            .then(response => response.json())
            .then(data => plates = data);

        
        window.onload = function() {
 
            entry = document.getElementById('entry');            
            button = document.getElementById('start-button');
            button.style.zIndex = "2";
            
            entry.style.opacity = 0;
            entry.disabled = true;
            entry.style.zIndex = "-1";
            
        
            document.getElementById('lexicon-chooser').style.zIndex = 1;


            document.getElementById('CSW21').onclick = function () {
                document.getElementById('copyright').innerHTML = 'Collins Official Scrabble Words,<br>an imprint of HarperCollins Publishers Limited.';
            }
            document.getElementById('NWL20').onclick = function () {
                document.getElementById('copyright').innerHTML = 'NASPA Word List, 2020 Edition,<br>Â© 2020 North American Word Game Players Association.';
            }
            document.getElementById('CEL').onclick = function () {
                document.getElementById('copyright').innerHTML = 'Common English Lexicon, a subset of CSW21,<br> by Eric Smith and Kenji Matsumoto.';
            }
            
            const element = document.querySelector('input[name="lexicon"]:checked');
            element.onclick.apply(element);
            
            entry.addEventListener("keyup", function(event) {
                if (event.keyCode === 13) {
                    submit(entry.value.toUpperCase());
                    entry.value = "";
                }
            });

        };
        
    


        /**
         * 
         */

        async function loadLexicon(wordlist) {
            
            await fetch("/dict/" + wordlist + "-top-plays.json")
                .then(response => response.json())
                .then(data => Object.keys(data).forEach(key => topPlays.set(key, data[key])));
    
            await fetch(new Request('/dict/' + wordlist +'.json'))
                .then(response => response.json())
                .then(data => data.forEach(item => lexicon.insert(item)));
        }
            

        

        /**
         * 
         */
  
        function loopLeft() {
            setTimeout(function() {
                if(!gameActive) return;
                nextPlate('animate-left');
                loopLeft();  
            }, Math.round(7000*Math.random()) + 7000);
        };
        
        function loopRight() {
            setTimeout(function() {
                if(!gameActive) return;
                nextPlate('animate-right');
                loopRight();  
            }, Math.round(7000*Math.random()) + 7000);
        
        };
        
        function loopSigns() {
            signsLoop = setTimeout(function() {
                nextSign();
                loopSigns();
            }, Math.round(70000*Math.random()) + 70000);
        };
        
        

        /**
         *
         */
        
        function startGame() {

            const wordlist = document.querySelector('input[name="lexicon"]:checked').value;

            Array.from(document.getElementsByClassName('start-item')).forEach(element => element.style.opacity = 0);
            Array.from(document.getElementsByClassName('start-item')).forEach(element => element.disabled = true);
            Array.from(document.getElementsByClassName('game-item')).forEach(element => element.style.opacity = 1);

            gameActive = true;
            score = 0,
            accuracy = [0, 0];
            document.getElementById('score').innerHTML = 'Score<br>' + score;
            document.getElementById('accuracy').innerHTML = 'Accuracy<br>--';
            
            button.innerHTML = "Loading...";
            button.disabled = true;
            loadLexicon(wordlist).then(() => {
                button.opacity = 0;
                button.style.zIndex = "-1";
                entry.disabled = false;
                entry.style.opacity = 1;
                entry.style.zIndex = "2";
                
                nextPlate('animate-left');
                setTimeout(() => loopLeft(), Math.round(7000*Math.random()));
                setTimeout(() => loopRight(), Math.round(7000*Math.random()) + 7000);
            //    loopSigns();
                
                setTimer();
            });
        }
        
        /**
         * 
         */
         
         function pause() {
             
             /* to implement later */
         }
        

        
        /**
         * 
         */ 
        
        function setTimer() {
            let minsLeft = 5;
            let secsLeft = 0;
            
            const timer = setInterval(function() {
                document.getElementById('timer').innerHTML = minsLeft + ":" + secsLeft.toString().padStart(2, 0);
                if(--secsLeft < 0) {
                    if(--minsLeft < 0) {
                        clearInterval(timer);
                        endGame();
                    }
                    else {
                        secsLeft += 60;
                    }
                }
                else if(minsLeft === 0) {
                    if(secsLeft <= 15) {
                        document.getElementById('timer').style.backgroundColor = secsLeft % 2 === 0 ? 'rgb(248, 186, 5)' : 'rgb(255, 102, 0)';
                    }
                    if(secsLeft <= 5) {
                        gameActive = false;
                    }
                }

            }, 1000);
        }
        
        /**
         * 
         */
         
        function endGame() {;
            
            document.getElementById('notification-area').innerHTML = "GAME OVER";
            document.querySelectorAll('.frame').forEach(frame => explode(frame));
            document.getElementById('timer').style.backgroundColor = 'rgb(0, 153, 0)';
            document.getElementById('timer').style.opacity = 0;

            button.style.opacity = 1;
            button.disabled = false;
            button.style.zIndex = "2";

            Array.from(document.getElementsByClassName('start-item')).forEach(element => element.style.opacity = 1);
            Array.from(document.getElementsByClassName('start-item')).forEach(element => element.disabled = false);
            entry.style.opacity = 0;
            entry.disabled = true;
            entry.style.zIndex = "-1";

            button.innerHTML = 'Play again';

        }
        
        /**
         * 
         */
         
         function nextSign() {
             const nextSign = document.createElement('img');
             nextSign.className = 'roadside';
             nextSign.setAttribute('src','https://www.seattlephysicstutor.com/images/twine.png');
             document.querySelector('.container').appendChild(nextSign);
         }

        
        /**
         * 
         */
        
        function nextPlate(selector) {

            let nextDigits = Math.floor(Math.random() * 1000).toString().padStart(3,0);
            let nextChars = "";
             while(!topPlays.has(nextChars)) {
                nextChars = "";
                for(i = 0; i < 3; i++) {
                    nextChars += (String.fromCharCode(65 + Math.floor(Math.random() * 26)));
                }
            }

            const nextLettering = document.createElement("p");
            nextLettering.className = 'lettering';            
            nextLettering.innerHTML = nextChars + " " + nextDigits;

            const nextFrame = document.createElement("div");
            nextFrame.classList.add('frame', selector);
            nextFrame.setAttribute('letters', nextChars);
            nextFrame.setAttribute('prevScore', 0);
            nextFrame.setAttribute('bestPlay', topPlays.get(nextChars));
            console.log(nextFrame.getAttribute('bestPlay'));

            const plateData = plates[Math.floor(Math.random() * plates.length)];
            const nextPlate = document.createElement('img');
            nextPlate.className ='plate';
            nextPlate.src = '/plates/'+ plateData[0] + '.jpg';
            nextLettering.style.fontFamily = plateData[1];
            nextLettering.style.color = plateData[2];
            nextLettering.style.bottom = plateData[3];
            nextPlate.onload = function () {
                nextFrame.appendChild(nextPlate);
                nextFrame.appendChild(nextLettering);            
                document.querySelector('.container').appendChild(nextFrame);
            }
     
            setTimeout(function() { 
                nextFrame.remove()
                accuracy[1] += 3;
                document.getElementById('accuracy').innerHTML = 'Accuracy<br>' + Math.round(100*accuracy[0]/accuracy[1]) + '%';
            }, 17000);
        }
        
        /**
         * 
         */

        function doScore(frame, points) {
            if(points >= 0) {
                frame.setAttribute('prevScore', points + Number(frame.getAttribute('prevScore')));
                const scoreAlert = document.createElement('div');
                scoreAlert.className = 'scoreAlert';
                scoreAlert.innerHTML = '+' + points;
                frame.appendChild(scoreAlert);
                
                score += points;
                accuracy[0] += points;
                document.getElementById('score').innerHTML = 'Score<br>' + score;
                
                setTimeout(function() {
                    scoreAlert.remove();
                }, 3000);
            }
        }

        
        /**
         * 
         */

        function explode(frame) {
            let target = new ImgExplode(frame.querySelector('.plate'));

            setTimeout(function () {
                frame.querySelector('.lettering').remove();
                target.explode({
                    maxWidth: 25,
                    minWidth: 5,
                    radius: 231,
                    release: false,
                    recycle: false,
                    explodeTime: 420,
                    canvas: true,
                    round: false,
                    maxAngle: 360,
                    gravity: 5,
                    groundDistance: 7,
                });
            }, 300);
        }
         


        /**
         * 
         */

	    function matches(plate, entry) {
		 
    		while(entry.length >= plate.length && plate.length > 0) {
    
    			if (plate.charAt(0) === entry.charAt(0)) {
    				plate = plate.substring(1);
    			}
    			entry = entry.substring(1);
    		}
    		return plate.length === 0;
    	}
    
    	 
    	
        /**
         * 
         */
        
        function submit(entry) {
            if(lexicon.contains(entry.toUpperCase())) {

                Array.from(document.getElementsByClassName('frame')).forEach(frame => {
                    let prevScore = Number(frame.getAttribute('prevScore'));
        			if(frame.getAttribute('bestPlay') === entry.toUpperCase()) {
        			    
        			    //equal in length to best play
                        doScore(frame, 3 - prevScore);
                        explode(frame);
        			}
        			else if(matches(frame.getAttribute('letters'), entry.toUpperCase())) {

        				if(frame.getAttribute('bestPlay').length === entry.length) {
        				    
        	    		    //equal in length to best play
        					doScore(frame, 2 - prevScore);
        				}
        				else {
        					doScore(frame, 1 - prevScore);
        				}
        			}
        		});
            }
        }

    </script>
    
</head>

<!-- ///////////////////////////////// -->
<!-- //////////    HTML     ////////// -->
<!-- ///////////////////////////////// -->

<div class='container'>
   <div id='controls'>
       <label class ='start-item' id="name-of-game" style>License to Spell</label>
       <div class='start-item' id='lexicon-chooser'>
          Word list:<br>
          <input type="radio" id="CSW21" name="lexicon" value="CSW21" checked="checked">
          <label for="words">CSW21</label>
          <input type="radio" id="NWL20" name="lexicon" value="NWL20">
          <label for="words">NWL20</label>
          <input type="radio" id="CEL" name="lexicon" value="CEL">
          <label for="words">Common words</label>
          <p id='copyright'></p>
       </div>
       
       <div class='start-item' id="how-to">
           <h4>How to play</h4>
           <p>Enter any word with the three letters of the plate in that order</p>
           
           <p>1 point: any valid word</p>
           
           <p>2 points: the shortest possible word</p>
           
           <p>3 points: shortest word and first alphabetically</p>
           
       </div>
     
       <button id="start-button" onclick='startGame()'>Start game</button>
       <label class='start-item' id='notification-area'></label>
       <input class='game-item' type="text" id="entry" placeholder="Enter a word" onload="this.value=''" onfocus="this.value=''; this.placeholder=''">
       <label class='game-item' id='timer' style="opacity:0">5:00</label>
       <label class='game-item' id='score' style="opacity:0">Score<br>0</label>        
       <label class='game-item' id='accuracy' style="opacity:0">Accuracy<br>--</label>
    </div>

    
  <svg class='backdrop' width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
    <polygon class='road' points="0,50 100,50 100,100 0,100" fill='rgb(92,94,98)'/>
    <polygon class='sky' points="0,0 100,00 100,50 0,50" fill='skyblue'/>
    <polygon class='left-margin' points="0,100 3,100 50,50" fill='rgb(248, 186, 5)'/>
    <polygon class='right-margin' points="100,100 97,100 50,50" fill='rgb(240, 241, 234)'/>
    <polygon class='shoulder' points="0,100 0,50 50,50 100,100 100,50 50,50" fill='green'/>
    <polygon class='dash' points="49.5,75 50.5,75 51,100 49, 100" fill='rgb(240, 241, 234)'/>
    <polygon class='dash delayed' points="49.5,75 50.5,75 51,100 49, 100" fill='rgb(240, 241, 234)'/>
    <!--line x1="30" y1="90" x2="45" y2="60" stroke="white" stroke-width="0.5"/-->
  </svg>

</div>
  
  
</html>
